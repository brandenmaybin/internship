---
title: "Clutch Work"
author: "Othon Hamill"
date: "October 24, 2018"
output: word_document
---

```{r}
#########################TO DO LIST############################
#Weights is the current issue. Whether clutch play and serves are equally valued as well as the actual values for clutch, null, and choke

#How are we going to deal with deuce points being both hold and break? Right now I'm including them in both, but we could just add another category since it's such a higher stress situation than a normal break or hold opprotunity

#How are we going to deal with returns hit into the net? 
```

```{r}
#call our necessary libraries
library(alr3)
library(MASS)
library(dplyr)
```

pservingonly function filters out opponents, leaving just BYU serving
```{r}
pservingonly<-function(rawdata){
  joint<-filter(rawdata,rawdata$server=="P")
}
```

highpressure function keeps only possible clutch points (a break or hold point)
```{r}
highpressure<-function(rawdata){
  #just clutch points, no sorting for server
hp<-rbind(
    rawdata[(rawdata$player.points == 0 & rawdata$opp.points == 3),],
    rawdata[(rawdata$player.points == 1 & rawdata$opp.points == 3),],
    rawdata[(rawdata$player.points == 2 & rawdata$opp.points == 3),],
    rawdata[(rawdata$player.points == 3 & rawdata$opp.points == 3),],
    rawdata[(rawdata$player.points == 3 & rawdata$opp.points == 2),],
    rawdata[(rawdata$player.points == 3 & rawdata$opp.points == 1),],
    rawdata[(rawdata$player.points == 3 & rawdata$opp.points == 0),])
  return(hp)
}
```

lowpressure function keeps everything but clutch points
```{r}
lowpressure<-function(rawdata){
  #just clutch points, no sorting for server
lp<-rawdata[(rawdata$player.points != 3 & rawdata$opp.points != 3),]
  return(lp)
}
```

acefilter: Returns all aces in a given dataset
```{r}
acefilter<-function(dataset){
  filter(dataset,dataset$serve.result=="A")
}
```

dffilter: Returns all double faults in a given dataset
```{r}
dffilter<-function(dataset){
  filter(dataset,dataset$serve.result=="D")
}
```

sclutchwins: Returns all short points won by BYU winners or opponent forced errors
```{r}
sclutchwins<-function(dataset){
  filter(dataset,dataset$point.length=="S" & dataset$point.winner=="P" & dataset$result %in% c("W","F"))
}
```

schokelosses: Returns all short points lost by opponent winners or BYU Forced errors 
Low Pressure Calculating function
```{r}
schokelosses<-function(dataset){
  filter(dataset,dataset$point.length=="S" & dataset$point.winner=="O" & dataset$result %in% c("W","F"))
}
```

Serving Scoring function
```{r}
servingscore<-function(dataset){
  clutch<-rbind(filter(dataset,dataset$point.winner=="P" & dataset$point.length=="S" & dataset$result %in% c("W","F") & dataset$server=="P"), filter(dataset, dataset$result=="A" & dataset$server=="P"))
  choke<-rbind(filter(dataset,dataset$point.winner=="O" & dataset$point.length=="S" & dataset$result %in% c("W","F") & dataset$server=="P"), filter(dataset, dataset$result=="D" & dataset$server=="P"))
  nullval<-dim(filter(dataset,dataset$server=="P"))[1]-dim(clutch)[1]-dim(choke)[1]
  #we can add in modifiers if we so desire here turning our score into a single value instead of 3 separate pieces
  score<-c(dim(clutch)[1],dim(choke)[1],nullval)
  return(score)
}
```

Play Scoring function
```{r}
playscore<-function(dataset){
  clutch<-filter(dataset,dataset$point.winner=="P" & dataset$result %in% c("W","F"))
  choke<-filter(dataset,dataset$point.winner=="O" & dataset$result == "U")
  nullval<-rbind(filter(dataset,dataset$point.winner=="P" & dataset$result == "U"), filter(dataset,dataset$point.winner=="O" & dataset$result %in% c("W","F")))
  #we can add in modifiers if we so desire here
  score<-c(dim(clutch)[1],dim(choke)[1],dim(nullval)[1])
  return(score)
}
```

Serving + Play Clutch Score
```{r}
clutchscore<-function(dataset){
  score<-playscore(dataset)+servingscore(dataset)
  return(score)
}
```


BYU Hold Point Calculating function
```{r}
BYUholdcolumn<-function(dataset){
  #build the BYU holding data frame including the deuce points
  byuholddf<-rbind(
    dataset[(dataset$player.points == 3 & dataset$opp.points == 3) & dataset$server== "P",],
    dataset[(dataset$player.points == 3 & dataset$opp.points == 2) & dataset$server== "P",],
    dataset[(dataset$player.points == 3 & dataset$opp.points == 1) & dataset$server== "P",],
    dataset[(dataset$player.points == 3 & dataset$opp.points == 0) & dataset$server== "P",])
  byuholdservingscore<-servingscore(byuholddf)
  byuholdplayscore<-playscore(byuholddf)
  byuholdclutchscore<-clutchscore(byuholddf)
  byuholdscores<-list(byuholdservingscore,byuholdplayscore,byuholdclutchscore)
  return(byuholdscores)
}
```

BYU being broken Point Calculating function
```{r}
BYUbreakcolumn<-function(dataset){
  #build the BYU to be broken data frame including the deuce points
  byubreakdf<-rbind(
    dataset[(dataset$player.points == 3 & dataset$opp.points == 3) & dataset$server== "P",],
    dataset[(dataset$player.points == 2 & dataset$opp.points == 3) & dataset$server== "P",],
    dataset[(dataset$player.points == 1 & dataset$opp.points == 3) & dataset$server== "P",],
    dataset[(dataset$player.points == 0 & dataset$opp.points == 3) & dataset$server== "P",])
  byubreakservingscore<-servingscore(byubreakdf)
  byubreakplayscore<-playscore(byubreakdf)
  byubreakclutchscore<-clutchscore(byubreakdf)
  byubreakscores<-list(byubreakservingscore,byubreakplayscore,byubreakclutchscore)
  return(byubreakscores)
}
```

Opp Hold Point Calculating function
```{r}
oppholdcolumn<-function(dataset){
  #build the opp holding data frame including the deuce points
  oppholddf<-rbind(
    dataset[(dataset$player.points == 3 & dataset$opp.points == 3) & dataset$server== "O",],
    dataset[(dataset$player.points == 2 & dataset$opp.points == 3) & dataset$server== "O",],
    dataset[(dataset$player.points == 1 & dataset$opp.points == 3) & dataset$server== "O",],
    dataset[(dataset$player.points == 0 & dataset$opp.points == 3) & dataset$server== "O",])
  oppholdplayscore<-playscore(oppholddf)
  oppholdclutchscore<-clutchscore(oppholddf)
  oppholdscores<-list(oppholdplayscore,oppholdclutchscore)
  return(oppholdscores)
}
```

Opp being broken Point Calculating function
```{r}
oppbreakcolumn<-function(dataset){
  #build the opp breaking data frame including the deuce points
  oppbreakdf<-rbind(
    dataset[(dataset$player.points == 3 & dataset$opp.points == 3) & dataset$server== "O",],
    dataset[(dataset$player.points == 3 & dataset$opp.points == 2) & dataset$server== "O",],
    dataset[(dataset$player.points == 3 & dataset$opp.points == 1) & dataset$server== "O",],
    dataset[(dataset$player.points == 3 & dataset$opp.points == 0) & dataset$server== "O",])
  oppbreakplayscore<-playscore(oppbreakdf)
  oppbreakclutchscore<-clutchscore(oppbreakdf)
  oppbreakscores<-list(oppbreakplayscore,oppbreakclutchscore)
  return(oppbreakscores)
}
```

Raw Combo makes the raw combo column in the clutch table. It should return a list of 3, each with 3 elements
```{r}
rawcombo<-function(dataset){
  #read in the four pressure column situations
  BYUhold<-BYUholdcolumn(dataset)
  BYUbreak<-BYUbreakcolumn(dataset)
  opphold<-oppholdcolumn(dataset)
  oppbreak<-oppbreakcolumn(dataset)
  
  #initialize and then fill in rawcombocolumn
  rawcombocolumn<-NULL
  
    s<-unlist(BYUhold[1])[1]+unlist(BYUbreak[1])[1]
    p<-unlist(BYUhold[1])[2]+unlist(BYUbreak[1])[2]
    c<-unlist(BYUhold[1])[3]+unlist(BYUbreak[1])[3]
    top<-c(s,p,c)
    
    s<-unlist(BYUhold[2])[1]+unlist(BYUbreak[2])[1]+unlist(opphold[1])[1]+unlist(oppbreak[1])[1]
    p<-unlist(BYUhold[2])[2]+unlist(BYUbreak[2])[2]+unlist(opphold[1])[2]+unlist(oppbreak[1])[2]
    c<-unlist(BYUhold[2])[3]+unlist(BYUbreak[2])[3]+unlist(opphold[1])[3]+unlist(oppbreak[1])[3]
    middle<-c(s,p,c)
    
    s<-unlist(BYUhold[3])[1]+unlist(BYUbreak[3])[1]+unlist(opphold[2])[1]+unlist(oppbreak[2])[1]
    p<-unlist(BYUhold[3])[2]+unlist(BYUbreak[3])[2]+unlist(opphold[2])[2]+unlist(oppbreak[2])[2]
    c<-unlist(BYUhold[3])[3]+unlist(BYUbreak[3])[3]+unlist(opphold[2])[3]+unlist(oppbreak[2])[3]
    bottom<-c(s,p,c)
  
  rawcombocolumn<-list(top,middle,bottom)
  return(rawcombocolumn)
}
```

The Wieghted combo function takes a dataset and a weight vector of length 12 it can apply to each combination of OPP/BYU/HOLD/BREAK being clutch, choke or neutral. It doesn't account for specific high-stress points, like a match points vs. a hold point in the first set. 
```{r}
wcombo<-function(dataset,weights=c(rep(1,times=12))){
  #read in the four pressure column situations
  BYUhold<-BYUholdcolumn(dataset)
  BYUbreak<-BYUbreakcolumn(dataset)
  opphold<-oppholdcolumn(dataset)
  oppbreak<-oppbreakcolumn(dataset)
  
  #initialize and then fill in rawcombocolumn
  wcombocolumn<-NULL
  
    s<-weights[1]*unlist(BYUhold[1])[1]+weights[2]*unlist(BYUbreak[1])[1]
    p<-weights[5]*unlist(BYUhold[1])[2]+weights[6]*unlist(BYUbreak[1])[2]
    c<-weights[9]*unlist(BYUhold[1])[3]+weights[10]*unlist(BYUbreak[1])[3]
    top<-c(s,p,c)
    
    s<-weights[1]*unlist(BYUhold[2])[1]+weights[2]*unlist(BYUbreak[2])[1]+weights[3]*unlist(opphold[1])[1]+weights[4]*unlist(oppbreak[1])[1]
    p<-weights[5]*unlist(BYUhold[2])[2]+weights[6]*unlist(BYUbreak[2])[2]+weights[7]*unlist(opphold[1])[2]+weights[8]*unlist(oppbreak[1])[2]
    c<-weights[9]*unlist(BYUhold[2])[3]+weights[10]*unlist(BYUbreak[2])[3]+weights[11]*unlist(opphold[1])[3]+weights[12]*unlist(oppbreak[1])[3]
    middle<-c(s,p,c)
    
    s<-weights[1]*unlist(BYUhold[3])[1]+weights[2]*unlist(BYUbreak[3])[1]+weights[3]*unlist(opphold[2])[1]+weights[4]*unlist(oppbreak[2])[1]
    p<-weights[5]*unlist(BYUhold[3])[2]+weights[6]*unlist(BYUbreak[3])[2]+weights[7]*unlist(opphold[2])[2]+weights[8]*unlist(oppbreak[2])[2]
    c<-weights[9]*unlist(BYUhold[3])[3]+weights[10]*unlist(BYUbreak[3])[3]+weights[11]*unlist(opphold[2])[3]+weights[12]*unlist(oppbreak[2])[3]
    bottom<-c(s,p,c)
  
  wcombocolumn<-list(top,middle,bottom)
  return(wcombocolumn)
}
```


fullanalysismatrix calls all our previous functions and turns them into a matrix that looks like our table we have under clutch analysis
```{r}
fullanalysismatrix<-function(dataset,weights=c(rep(1,times=12))){
  MATRIX<-matrix(data=NULL,nrow=3,ncol = 7)
  rownames(MATRIX)<-c("Clutch Serving Score","Clutch Playing Score", "OVERALL CLUTCH SCORE")
  colnames(MATRIX)<-c("Low Pressure Situations","BYU Hold", "")
  return(MATRIX)
}
```





~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~WORKING EXAMPLES~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~``

Let's read in Ethan's data
```{r}
#read it in and separate out just the parts we need
ethantest<-read.csv("Ethan test.csv",header=T)[1:71,]
ethanservingdata<-(cbind(ethantest[,c(11:12,14:16,18:21,22:24)],ethantest[,32]))
ethanjoint<-as.tbl(ethanservingdata)
colnames(ethanjoint)<-c("player.sets","opp.sets","player.games","opp.games","server", "player.points", "opp.points", "serve.result", "serve.location", "return.location", "result", "point.winner", "point.length")
```

Now let's test the simple functions on Ethan's Data
```{r}
ethanhp<-highpressure(ethanjoint)
ethanlp<-lowpressure(ethanjoint)
ethansclutch<-sclutchwins(ethanjoint)
ethanschoke<-schokelosses(ethanjoint)
servingscore(ethanjoint) #add to 36 which is our # of times P served
playscore(ethanjoint) #total is 44, so we need to prove we discount 27. Which is exactly the number of times the result is either empty, "A" or "D"
clutchscore(ethanjoint) #works out fine
```

Generates what values will be scored and THEN put into the table. These are values, not actual scores yet. 
```{r}
#concern: With the Ethan data serve returns into the net weren't logged as forced or unforced errors...
#BUT, all the functions are verified to work fine otherwise as of Nov 12

#weights for the wcombo

(ethanNONclutchsit<-list(servingscore(ethanlp),playscore(ethanlp),clutchscore(ethanlp)))
(ethanBYUhold<-BYUholdcolumn(ethanjoint))
(ethanBYUbreak<-BYUbreakcolumn(ethanjoint))
(ethanopphold<-oppholdcolumn(ethanjoint))
(ethanoppbreak<-oppbreakcolumn(ethanjoint))
(ethanrawcombo<-rawcombo(ethanjoint))
(ethanwcombo<-wcombo(ethanjoint)) #could add an additional vector for weights, otherwise it computes raw currently
```


Just a workspace chunk
```{r}


```

